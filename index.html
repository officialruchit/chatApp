<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <h1>Chat Application</h1>

    <h2>Sign Up</h2>
    <input type="text" id="signupName" placeholder="Name" />
    <input type="email" id="signupEmail" placeholder="Email" />
    <input type="password" id="signupPassword" placeholder="Password" />
    <button onclick="signup()">Sign Up</button>

    <h2>Sign In</h2>
    <input type="email" id="signinEmail" placeholder="Email" />
    <input type="password" id="signinPassword" placeholder="Password" />
    <button onclick="signin()">Sign In</button>

    <div id="chat">
      <div>
        <button onclick="joinchat()">Join Chat</button>
      </div>
    </div>
    <div>
      <label for="receiver">Send To (Socket ID): </label>
      <input type="text" id="receiver">
    </div>
    <div>
      <label for="message">Message: </label>
      <input type="text" id="message">
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="messages"></div>
  </div>


    <script>
      const socket = io();
       let token = localStorage.getItem('token');;
      let senderId = null;

   async function signup() {
      const name = document.getElementById("signupName").value;
      const email = document.getElementById("signupEmail").value;
      const password = document.getElementById("signupPassword").value;

      const response = await fetch("/signup", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ name, mail: email, password }),
      });

      const data = await response.json();
      if (response.status === 201) {
        token = data;
        localStorage.setItem('token', token);
        alert("Sign up successful!");
      } else {
        alert(data.msg || "Sign up failed!");
      }
    }
    
    async function signin() {
      const email = document.getElementById("signinEmail").value;
      const password = document.getElementById("signinPassword").value;

      const response = await fetch("/signin", {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ mail: email, password }),
      });

      const data = await response.json();
      if (response.status === 200) {
        alert("Sign in successful!");
      } else {
        alert("Invalid email or password!");
      }
    }

async function joinchat(){
  let token1=localStorage.getItem('token');
  if (!token1) {
        alert("Please sign in first.");
        return;
      }
      const response = await fetch('/me', {
        method: 'GET',
        headers: {
          Authorization: `Bearer ${token1}`,
        },
      });
      if (response.ok) {
        const user = await response.json();
        console.log("user",user)
        userId = user._id;
        
        socket.emit('join', { userId, username: user.name });
      } else {
        console.error('Failed to fetch user details');
      }
}

      function sendMessage() {
      const receiverId = document.getElementById('receiver').value;
      const message = document.getElementById('message').value;
      console.log(message,receiverId)
      socket.emit('private_message', { receiverId, message });
    }

    socket.on('private_message', (data) => {
      const { message, sender } = data;
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML += `<p><strong>${sender}:</strong> ${message}</p>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight; 
    });
    </script>
  </body>
</html>
